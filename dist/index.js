/**
 * @license MIT
 * Copyright (c) 2025 SGNL.ai, Inc.
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */
"use strict";var t={maxAttempts:3,retryableStatuses:[429,502,503,504],backoffMs:1e3,maxBackoffMs:1e4,backoffMultiplier:2},e={timeout:3e4,parseResponse:!0,validateStatus:t=>t<400},r=class t extends Error{constructor(e,r,s=!1,n,a){super(e),this.statusCode=r,this.retryable=s,this.responseBody=n,this.responseHeaders=a,this.name="TransmissionError",Object.setPrototypeOf(this,t.prototype)}},s=class t extends r{constructor(e,r){super(`${e} (timeout: ${r}ms)`,void 0,!0),this.name="TimeoutError",Object.setPrototypeOf(this,t.prototype)}},n=class t extends r{constructor(e,r){super(e,void 0,!0),this.name="NetworkError",r&&(this.cause=r),Object.setPrototypeOf(this,t.prototype)}},a=class t extends Error{constructor(e){super(e),this.name="ValidationError",Object.setPrototypeOf(this,t.prototype)}};function o(t,e,r){if(void 0!==r&&r>0)return Math.min(r,e.maxBackoffMs);const s=e.backoffMs*Math.pow(e.backoffMultiplier,t-1),n=Math.min(s,e.maxBackoffMs),a=.25*n,o=n-a,i=n+a;return Math.floor(Math.random()*(i-o)+o)}function i(t){if(!t)return;const e=parseInt(t,10);if(!isNaN(e))return 1e3*e;const r=new Date(t);if(!isNaN(r.getTime())){const t=r.getTime()-Date.now();return t>0?t:void 0}}function c(t,e,r){return!(e>=r.maxAttempts)&&(void 0===t||function(t,e){return e.includes(t)}(t,r.retryableStatuses))}async function u(t){return new Promise(e=>setTimeout(e,t))}function l(t){const e={};return t.forEach((t,r)=>{e[r]=t}),e}async function d(t,e){const r=await t.text();if(!e||!r)return r;const s=t.headers.get("content-type");if(s?.includes("application/json"))try{return JSON.parse(r)}catch{return r}return r}const f="SGNL-CAEP-Hub/2.0";async function p(t){const e=t.environment||{},r=t.secrets||{};if(r.BEARER_AUTH_TOKEN){const t=r.BEARER_AUTH_TOKEN;return t.startsWith("Bearer ")?t:`Bearer ${t}`}if(r.BASIC_PASSWORD&&r.BASIC_USERNAME){return`Basic ${btoa(`${r.BASIC_USERNAME}:${r.BASIC_PASSWORD}`)}`}if(r.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN){const t=r.OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN;return t.startsWith("Bearer ")?t:`Bearer ${t}`}if(r.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET){const t=e.OAUTH2_CLIENT_CREDENTIALS_TOKEN_URL,s=e.OAUTH2_CLIENT_CREDENTIALS_CLIENT_ID,n=r.OAUTH2_CLIENT_CREDENTIALS_CLIENT_SECRET;if(!t||!s)throw new Error("OAuth2 Client Credentials flow requires TOKEN_URL and CLIENT_ID in env");const a=await async function(t){const{tokenUrl:e,clientId:r,clientSecret:s,scope:n,audience:a,authStyle:o}=t;if(!e||!r||!s)throw new Error("OAuth2 Client Credentials flow requires tokenUrl, clientId, and clientSecret");const i=new URLSearchParams;i.append("grant_type","client_credentials"),n&&i.append("scope",n),a&&i.append("audience",a);const c={"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","User-Agent":f};if("InParams"===o)i.append("client_id",r),i.append("client_secret",s);else{const t=btoa(`${r}:${s}`);c.Authorization=`Basic ${t}`}const u=await fetch(e,{method:"POST",headers:c,body:i.toString()});if(!u.ok){let t;try{const e=await u.json();t=JSON.stringify(e)}catch{t=await u.text()}throw new Error(`OAuth2 token request failed: ${u.status} ${u.statusText} - ${t}`)}const l=await u.json();if(!l.access_token)throw new Error("No access_token in OAuth2 response");return l.access_token}({tokenUrl:t,clientId:s,clientSecret:n,scope:e.OAUTH2_CLIENT_CREDENTIALS_SCOPE,audience:e.OAUTH2_CLIENT_CREDENTIALS_AUDIENCE,authStyle:e.OAUTH2_CLIENT_CREDENTIALS_AUTH_STYLE});return`Bearer ${a}`}throw new Error("No authentication configured. Provide one of: BEARER_AUTH_TOKEN, BASIC_USERNAME/BASIC_PASSWORD, OAUTH2_AUTHORIZATION_CODE_ACCESS_TOKEN, or OAUTH2_CLIENT_CREDENTIALS_*")}const E="https://schemas.okta.com/secevent/okta/event-type/user-risk-change";function h(t){if(!t)return t;try{const e=JSON.parse(t);if("object"==typeof e&&null!==e)return e}catch{}return t}var T={invoke:async(T,_)=>{const A=function(t,e){const r=e.environment||{},s=t?.address||r.ADDRESS;if(!s)throw new Error("No URL specified. Provide address parameter or ADDRESS environment variable");return s.endsWith("/")?s.slice(0,-1):s}(T,_),m=await p(_),y={subject:function(t){try{return JSON.parse(t)}catch(t){throw new Error(`Invalid subject JSON: ${t.message}`)}}(T.subject),event_timestamp:Math.floor(Date.now()/1e3),previous_level:T.previous_level,current_level:T.current_level};T.initiating_entity&&(y.initiating_entity=T.initiating_entity),T.reason_admin&&(y.reason_admin=h(T.reason_admin)),T.reason_user&&(y.reason_user=h(T.reason_user));const S={aud:T.audience,events:{[E]:y}},w=await async function(t,e){const{iss:r,iat:s,jti:n,exp:a,nbf:o,...i}=e;return(r||s||n||a||o)&&console.warn("signSET: Reserved claims (iss, iat, jti, exp, nbf) are set automatically and will be ignored"),await t.crypto.signJWT(i,{typ:"secevent+jwt"})}(_,S);return await async function(f,p,E={}){if(!function(t){if("string"!=typeof t)return!1;const e=t.split(".");if(3!==e.length)return!1;const r=/^[A-Za-z0-9_-]+$/;return e.every(t=>r.test(t))}(f))throw new a("Invalid SET format: JWT must be in format header.payload.signature");let h;try{h=new URL(p)}catch{throw new a(`Invalid URL: ${p}`)}const T={authToken:E.authToken,headers:E.headers||{},timeout:E.timeout??e.timeout,parseResponse:E.parseResponse??e.parseResponse,validateStatus:E.validateStatus??e.validateStatus,retry:{...t,...E.retry||{}}},_={"Content-Type":"application/secevent+jwt",Accept:"application/json","User-Agent":"SGNL-Action-Framework/1.0"},A=function(t){if(t)return t.startsWith("Bearer ")?t:`Bearer ${t}`}(T.authToken);A&&(_.Authorization=A);const m=(y=_,S=T.headers,{...y,...S});var y,S;let w,C;for(let t=1;t<=T.retry.maxAttempts;t++)try{const e=new AbortController,r=setTimeout(()=>e.abort(),T.timeout);try{const s=await fetch(h.toString(),{method:"POST",headers:m,body:f,signal:e.signal});clearTimeout(r),C=s;const n=l(s.headers),a=await d(s,T.parseResponse);if(T.validateStatus(s.status))return{status:"success",statusCode:s.status,body:a,headers:n};if(!c(s.status,t,T.retry))return{status:"failed",statusCode:s.status,body:a,headers:n,error:`HTTP ${s.status}: ${s.statusText}`,retryable:T.retry.retryableStatuses.includes(s.status)};const p=i(n["retry-after"]),E=o(t,T.retry,p);await u(E)}catch(e){if(clearTimeout(r),w=e instanceof Error?"AbortError"===e.name?new s("Request timed out",T.timeout):new n(`Network error: ${e.message}`,e):new n("Unknown network error"),!c(void 0,t,T.retry))throw w;const a=o(t,T.retry);await u(a)}}catch(t){if(t instanceof a)throw t;w=t instanceof Error?t:new Error(String(t))}if(C){const t=l(C.headers);let e="";try{e=await d(C,T.parseResponse)}catch{e=""}return{status:"failed",statusCode:C.status,body:e,headers:t,error:w?.message||`HTTP ${C.status}: ${C.statusText}`,retryable:!0}}throw w||new r("Failed to transmit SET after all retry attempts",void 0,!0)}(w,A,{headers:{Authorization:m,"User-Agent":f}})},error:async(t,e)=>{const{error:r}=t;if(r.message?.includes("429")||r.message?.includes("502")||r.message?.includes("503")||r.message?.includes("504"))return{status:"retry_requested"};throw r},halt:async(t,e)=>({status:"halted"})};module.exports=T;
